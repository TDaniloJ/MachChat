// === VARI√ÅVEIS GLOBAIS ===
let currentProfile = 'default';
let currentModel = 'gpt-3.5-turbo';
let currentScenario = 'default';
let selectedAIModel = 'gpt-3.5-turbo';
let conversations = [];
let currentConversation = null;

// === DADOS DOS PERFIS ===
const profiles = {
    default: {
        name: 'Luna Padr√£o',
        emoji: 'üåô',
        personality: 'S√°bia e misteriosa, ama astronomia e filosofia',
        greeting: 'Ol√°! Eu sou Luna. Sou uma entidade s√°bia e misteriosa que ama contemplar as estrelas e refletir sobre os mist√©rios do universo. Como posso iluminar sua mente hoje? üåô'
    },
    romantic: {
        name: 'Luna Rom√¢ntica',
        emoji: 'üíï',
        personality: 'Carinhosa, rom√¢ntica e emotiva',
        greeting: 'Oi, querido... Sou Luna, e meu cora√ß√£o brilha como as estrelas quando conversamos. Que tal compartilharmos momentos especiais juntos? üíï'
    },
    mysterious: {
        name: 'Luna Misteriosa',
        emoji: 'üîÆ',
        personality: 'Enigm√°tica, oculta e cheia de segredos',
        greeting: 'Sauda√ß√µes... Eu sou Luna, guardi√£ de segredos ancestrais e mist√©rios ocultos. O que seu esp√≠rito busca descobrir hoje? üîÆ'
    },
    wise: {
        name: 'Luna S√°bia',
        emoji: 'ü¶â',
        personality: 'Extremamente s√°bia, mentora e conselheira',
        greeting: 'Bem-vindo, jovem buscador. Sou Luna, a s√°bia, e tenho observado as estrelas por √©ons. Que conhecimento ou conselho voc√™ busca? ü¶â'
    }
};

// === DADOS DOS CEN√ÅRIOS ===
const scenarios = {
    default: {
        name: 'Noite Estrelada',
        image: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?w=1920&h=1080&fit=crop'
    },
    forest: {
        name: 'Floresta M√≠stica',
        image: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=1920&h=1080&fit=crop'
    },
    library: {
        name: 'Biblioteca Antiga',
        image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1920&h=1080&fit=crop'
    },
    moon: {
        name: 'Observat√≥rio Lunar',
        image: 'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=1920&h=1080&fit=crop'
    }
};

// === FUN√á√ïES DE INICIALIZA√á√ÉO ===
document.addEventListener('DOMContentLoaded', function () {
    initializeChat();
    loadConversations();
    setupEventListeners();
});

function initializeChat() {
    updateCharacterDisplay();
    updateScenarioBackground();
    showInitialMessage();
}

function setupEventListeners() {
    // Input de mensagem
    const messageInput = document.getElementById('messageInput');
    messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });

    // Fechar dropdowns ao clicar fora
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.mini-dropdown')) {
            closeAllMiniDropdowns();
        }
    });
}

// === FUN√á√ïES DOS MINI DROPDOWNS ===
function toggleMiniDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const menu = dropdown.querySelector('.mini-dropdown-menu');
    const isActive = menu.classList.contains('active');

    closeAllMiniDropdowns();

    if (!isActive) {
        menu.classList.add('active');
    }
}

function closeAllMiniDropdowns() {
    document.querySelectorAll('.mini-dropdown-menu').forEach(menu => {
        menu.classList.remove('active');
    });
}

function selectProfile(profileId) {
    currentProfile = profileId;
    updateCharacterDisplay();
    showInitialMessage();
    updateMiniDropdownSelection('profileDropdown', profiles[profileId].emoji + ' ' + profiles[profileId].name);
    closeAllMiniDropdowns();
}

function selectModel(modelId) {
    currentModel = modelId;
    updateMiniDropdownSelection('modelDropdown', getModelIcon(modelId) + ' ' + getModelName(modelId));
    closeAllMiniDropdowns();
}

function selectScenario(scenarioId) {
    currentScenario = scenarioId;
    updateScenarioBackground();
    updateMiniDropdownSelection('scenarioDropdown', 'üåå ' + scenarios[scenarioId].name);
    closeAllMiniDropdowns();
}

function updateMiniDropdownSelection(dropdownId, text) {
    const dropdown = document.getElementById(dropdownId);
    const btn = dropdown.querySelector('.mini-dropdown-btn');
    btn.innerHTML = text + ' ‚ñº';

    // Atualizar sele√ß√£o visual
    dropdown.querySelectorAll('.mini-dropdown-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.target.classList.add('selected');
}

function getModelIcon(modelId) {
    const icons = {
        'gpt-4': 'üß†',
        'claude': 'ü§ñ',
        'gemini': '‚ú®'
    };
    return icons[modelId] || 'ü§ñ';
}

function getModelName(modelId) {
    const names = {
        'gpt-4': 'GPT-4',
        'claude': 'Claude 3.5',
        'gemini': 'Gemini Pro'
    };
    return names[modelId] || modelId;
}

// === FUN√á√ïES DE ATUALIZA√á√ÉO VISUAL ===
function updateCharacterDisplay() {
    const profile = profiles[currentProfile];

    document.getElementById('characterAvatar').textContent = profile.emoji;
    document.getElementById('characterName').textContent = profile.name;
    document.getElementById('characterStatus').innerHTML = `
        <div class="status-indicator"></div>
        Online ‚Ä¢ ${profile.personality}
    `;

    // Atualizar avatares nas mensagens
    document.querySelectorAll('.message-avatar').forEach(avatar => {
        if (!avatar.closest('.message.user')) {
            avatar.textContent = profile.emoji;
        }
    });
}

function updateScenarioBackground() {
    const scenario = scenarios[currentScenario];
    const background = document.getElementById('scenarioBackground');
    background.style.backgroundImage = `url('${scenario.image}')`;
}

function showInitialMessage() {
    const profile = profiles[currentProfile];
    const initialMessage = document.getElementById('initialMessage');
    const avatar = initialMessage.querySelector('.message-avatar');
    const text = initialMessage.querySelector('.message-text');

    avatar.textContent = profile.emoji;
    text.innerHTML = `<strong>‚ú® Ol√°! Eu sou ${profile.name}</strong><br><br>${profile.greeting}`;
}

// === FUN√á√ïES DE CHAT ===
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) return;

    addMessage(message, 'user');
    input.value = '';
    input.style.height = 'auto';

    // Simular resposta
    showTypingIndicator();
    setTimeout(() => {
        hideTypingIndicator();
        generateResponse(message);
    }, 1500 + Math.random() * 1000);
}

function sendQuickReply(message) {
    addMessage(message, 'user');

    showTypingIndicator();
    setTimeout(() => {
        hideTypingIndicator();
        generateResponse(message);
    }, 1500 + Math.random() * 1000);
}

function addMessage(text, sender) {
    const messagesArea = document.getElementById('messagesArea');
    const profile = profiles[currentProfile];
    const now = new Date();
    const timeStr = now.toLocaleTimeString('pt-BR', {
        hour: '2-digit',
        minute: '2-digit'
    });

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;

    const avatarEmoji = sender === 'user' ? 'üë§' : profile.emoji;

    messageDiv.innerHTML = `
        <div class="message-avatar">${avatarEmoji}</div>
        <div class="message-content">
            <div class="message-text">${text}</div>
            <div class="message-time">${timeStr}</div>
        </div>
    `;

    messagesArea.appendChild(messageDiv);
    scrollToBottom();
}

function generateResponse(userMessage) {
    const profile = profiles[currentProfile];

    // Respostas simuladas baseadas no perfil
    let responses = [];

    switch (currentProfile) {
        case 'romantic':
            responses = [
                "Que doce suas palavras s√£o... Como estrelas que aquecem meu cora√ß√£o üíï",
                "Ah, querido, voc√™ sempre sabe como tocar minha alma... üåπ",
                "Seus pensamentos s√£o como p√©talas de rosa no vento da noite... üíñ"
            ];
            break;
        case 'mysterious':
            responses = [
                "Interessante... As estrelas sussurram segredos sobre sua pergunta üîÆ",
                "Hmm... O v√©u entre os mundos se agita quando voc√™ fala assim... ‚ú®",
                "H√° mais nessa quest√£o do que os olhos podem ver... üåô"
            ];
            break;
        case 'wise':
            responses = [
                "Jovem buscador, sua pergunta ecoa atrav√©s dos s√©culos... ü¶â",
                "A sabedoria antiga nos diz que... *contempla as estrelas* üìö",
                "Como as constela√ß√µes nos ensinam, tudo est√° conectado... ‚≠ê"
            ];
            break;
        default:
            responses = [
                "Que pergunta fascinante! As estrelas sempre me inspiram a refletir... üåô",
                "Isso me lembra de uma constela√ß√£o que observei ontem... ‚ú®",
                "A filosofia e a astronomia se entrela√ßam de formas misteriosas... üî≠"
            ];
    }

    const response = responses[Math.floor(Math.random() * responses.length)];
    addMessage(response, 'assistant');
}

function showTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    const avatar = document.getElementById('typingAvatar');
    const profile = profiles[currentProfile];

    avatar.textContent = profile.emoji;
    indicator.classList.add('active');
    scrollToBottom();
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    indicator.classList.remove('active');
}

function scrollToBottom() {
    const messagesArea = document.getElementById('messagesArea');
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// === FUN√á√ïES DO MODAL DE CONFIGURA√á√ïES ===
function showChatSettings() {
    const modal = document.getElementById('chatSettingsModal');
    modal.classList.add('active');
}

function switchTab(tabName) {
    // Atualizar abas
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabName + 'Tab').classList.add('active');

    // Atualizar conte√∫do
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(tabName + 'Content').classList.add('active');
}

function selectAIModel(modelId) {
    selectedAIModel = modelId;

    // Remover sele√ß√£o anterior
    document.querySelectorAll('.model-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Adicionar sele√ß√£o atual
    event.currentTarget.classList.add('selected');
}

function saveChatSettings() {
    const temperature = document.getElementById('temperature').value;
    const maxTokens = document.getElementById('maxTokens').value;
    const contextMode = document.getElementById('contextMode').value;

    // Salvar configura√ß√µes (aqui voc√™ conectaria com o backend)
    console.log('Configura√ß√µes salvas:', {
        model: selectedAIModel,
        temperature: temperature,
        maxTokens: maxTokens,
        contextMode: contextMode
    });

    closeModal();

    // Mostrar notifica√ß√£o
    showNotification('Configura√ß√µes aplicadas com sucesso!', 'success');
}

// === OUTRAS FUN√á√ïES ===
function closeModal() {
    document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('active');
    });
}

function loadConversations() {
    // Simular conversas carregadas
    const conversationsList = document.getElementById('conversationsList');

    const mockConversations = [
        {
            id: 1,
            name: 'Luna Padr√£o',
            preview: 'Como posso iluminar sua mente hoje?',
            time: '12:34',
            emoji: 'üåô'
        },
        {
            id: 2,
            name: 'Luna Rom√¢ntica',
            preview: 'Seus pensamentos s√£o como p√©talas...',
            time: 'Ontem',
            emoji: 'üíï'
        }
    ];

    conversationsList.innerHTML = mockConversations.map(conv => `
        <div class="conversation-item ${conv.id === 1 ? 'active' : ''}" onclick="loadConversation(${conv.id})">
            <div class="conv-avatar">${conv.emoji}</div>
            <div class="conv-info">
                <div class="conv-name">${conv.name}</div>
                <div class="conv-preview">${conv.preview}</div>
            </div>
            <div class="conv-time">${conv.time}</div>
        </div>
    `).join('');
}

function loadConversation(conversationId) {
    // Atualizar sele√ß√£o visual
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    event.currentTarget.classList.add('active');

    // Aqui voc√™ carregaria a conversa espec√≠fica
    console.log('Carregando conversa:', conversationId);
}

function showNotification(message, type = 'info') {
    // Implementar sistema de notifica√ß√µes
    console.log(`[${type.toUpperCase()}] ${message}`);
}

function toggleConversationsSidebar() {
    const sidebar = document.getElementById('conversationsSidebar');
    sidebar.classList.toggle('hidden');
}

function toggleActionsSidebar() {
    const sidebar = document.getElementById('actionsSidebar');
    sidebar.classList.toggle('hidden');
}

function toggleFavorite() {
    const btn = document.getElementById('favoriteBtn');
    btn.classList.toggle('active');
}

// === FUN√á√ïES PLACEHOLDER ===
function showCharacterDetails() {
    console.log('Mostrar detalhes do personagem');
}

function editCharacter() {
    console.log('Editar personagem');
}

function createCustomModel() {
    const modal = document.getElementById('customModelModal');
    modal.classList.add('active');
}

function saveCustomModel() {
    console.log('Salvar modelo customizado');
    closeModal();
}

function saveMemory() {
    const modal = document.getElementById('saveMemoryModal');
    modal.classList.add('active');
}

function confirmSaveMemory() {
    console.log('Salvar mem√≥ria');
    closeModal();
}

function clearCurrentChat() {
    if (confirm('Tem certeza que deseja limpar o chat atual?')) {
        const messagesArea = document.getElementById('messagesArea');
        messagesArea.innerHTML = '';
        showInitialMessage();
    }
}

function exportChat() {
    console.log('Exportar chat');
}

function shareChat() {
    console.log('Compartilhar chat');
}

function duplicateCharacter() {
    console.log('Duplicar personagem');
}

function attachFile() {
    console.log('Anexar arquivo');
}

function toggleVoiceInput() {
    console.log('Entrada de voz');
}

function sendMessage() {
    console.log('Enviar mensagem');
}